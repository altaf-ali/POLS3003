<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Lab | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.2.0">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
    

        
    
    
    <link rel="next" href="../../ISLR/chapter7/solutions.html" />
    
    
    <link rel="prev" href="../../week5/index.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="5.2.1" data-basepath="../.." data-revision="Mon Aug 03 2015 17:32:12 GMT+0100 (BST)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="week1/index.html">
            
            <span><b>1.</b> Week 1</span>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="week2/index.html">
            
            <span><b>2.</b> Week 2</span>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="week3/index.html">
            
                
                    <a href="../../week3/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Week 3
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="week3/index.html">
            
                
                    <a href="../../week3/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Chapter 5. Resampling Methods
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="ISLR/chapter5/lab.html">
            
                
                    <a href="../../ISLR/chapter5/lab.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.1.</b>
                        
                        Lab
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="ISLR/chapter5/solutions.html">
            
                
                    <a href="../../ISLR/chapter5/solutions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.2.</b>
                        
                        Solutions
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="week4/index.html">
            
                
                    <a href="../../week4/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Week 4
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="week4/index.html">
            
                
                    <a href="../../week4/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Chapter 3. Linear Regression
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="ISLR/chapter3/lab.html">
            
                
                    <a href="../../ISLR/chapter3/lab.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.1.</b>
                        
                        Lab
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="ISLR/chapter3/solutions.html">
            
                
                    <a href="../../ISLR/chapter3/solutions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.2.</b>
                        
                        Solutions
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="week5/index.html">
            
                
                    <a href="../../week5/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Week 5
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="week4/index.html">
            
                
                    <a href="../../week4/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                        Chapter 4. Classification
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="ISLR/chapter4/lab.html">
            
                
                    <a href="../../ISLR/chapter4/lab.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.1.</b>
                        
                        Lab
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="ISLR/chapter4/solutions.html">
            
                
                    <a href="../../ISLR/chapter4/solutions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.2.</b>
                        
                        Solutions
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="week5/index.html">
            
                
                    <a href="../../week5/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                        Chapter 7. Moving Beyond Linearity
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="5.2.1" data-path="ISLR/chapter7/lab.html">
            
                
                    <a href="../../ISLR/chapter7/lab.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.1.</b>
                        
                        Lab
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2.2" data-path="ISLR/chapter7/solutions.html">
            
                
                    <a href="../../ISLR/chapter7/solutions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.2.</b>
                        
                        Solutions
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" data-path="week6/index.html">
            
            <span><b>6.</b> Week 6</span>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="week7/index.html">
            
            <span><b>7.</b> Week 7</span>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="week8/index.html">
            
            <span><b>8.</b> Week 8</span>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="week9/index.html">
            
            <span><b>9.</b> Week 9</span>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="week10/index.html">
            
            <span><b>10.</b> Week 10</span>
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h2 id="7-8-lab-non-linear-modeling">7.8 Lab: Non-linear Modeling</h2>
<p>We begin by loading that <code>ISLR</code> package and attaching to the <code>Wage</code> dataset that we will be using throughtout this exercise.</p>
<pre><code class="lang-r"><span class="hljs-keyword">library</span>(ISLR)
<span class="hljs-keyword">attach</span>(Wage)
</code></pre>
<h3 id="7-8-1-polynomial-regression-and-step-functions">7.8.1 Polynomial Regression and Step Functions</h3>
<p>Let&apos;s fit a linear model to predict <code>wage</code> with a forth-degree polynomial using the <a href="http://bit.ly/R_poly" target="_blank"><code>poly()</code></a></p>
<pre><code class="lang-r">fit &lt;- lm(wage ~ poly(age, <span class="hljs-number">4</span>), data = Wage)
coef(summary(fit))
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:right">Estimate</th>
<th style="text-align:right">Std. Error</th>
<th style="text-align:right">t value</th>
<th style="text-align:right">Pr(&gt;|t|)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(Intercept)</td>
<td style="text-align:right">111.70361</td>
<td style="text-align:right">0.7287409</td>
<td style="text-align:right">153.283015</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4)1</td>
<td style="text-align:right">447.06785</td>
<td style="text-align:right">39.9147851</td>
<td style="text-align:right">11.200558</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4)2</td>
<td style="text-align:right">-478.31581</td>
<td style="text-align:right">39.9147851</td>
<td style="text-align:right">-11.983424</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4)3</td>
<td style="text-align:right">125.52169</td>
<td style="text-align:right">39.9147851</td>
<td style="text-align:right">3.144742</td>
<td style="text-align:right">0.0016786</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4)4</td>
<td style="text-align:right">-77.91118</td>
<td style="text-align:right">39.9147851</td>
<td style="text-align:right">-1.951938</td>
<td style="text-align:right">0.0510386</td>
</tr>
</tbody>
</table>
<p>We can also obtain raw instead of orthogonal polynomials using the <code>raw = TRUE</code> argument to <a href="http://bit.ly/R_poly" target="_blank"><code>poly()</code></a></p>
<pre><code class="lang-r">fit2 &lt;- lm(wage ~ poly(age, <span class="hljs-number">4</span>, raw = <span class="hljs-literal">T</span>), data = Wage)
coef(summary(fit2))
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:right">Estimate</th>
<th style="text-align:right">Std. Error</th>
<th style="text-align:right">t value</th>
<th style="text-align:right">Pr(&gt;|t|)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(Intercept)</td>
<td style="text-align:right">-184.1541798</td>
<td style="text-align:right">60.0403772</td>
<td style="text-align:right">-3.067172</td>
<td style="text-align:right">0.0021803</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4, raw = T)1</td>
<td style="text-align:right">21.2455205</td>
<td style="text-align:right">5.8867482</td>
<td style="text-align:right">3.609042</td>
<td style="text-align:right">0.0003124</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4, raw = T)2</td>
<td style="text-align:right">-0.5638593</td>
<td style="text-align:right">0.2061083</td>
<td style="text-align:right">-2.735743</td>
<td style="text-align:right">0.0062606</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4, raw = T)3</td>
<td style="text-align:right">0.0068107</td>
<td style="text-align:right">0.0030659</td>
<td style="text-align:right">2.221409</td>
<td style="text-align:right">0.0263978</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 4, raw = T)4</td>
<td style="text-align:right">-0.0000320</td>
<td style="text-align:right">0.0000164</td>
<td style="text-align:right">-1.951938</td>
<td style="text-align:right">0.0510386</td>
</tr>
</tbody>
</table>
<p>Finally, instead of using <a href="http://bit.ly/R_poly" target="_blank"><code>poly()</code></a>, we can specify the polynomials directly in the formula as shown below.</p>
<pre><code class="lang-r">fit2a &lt;- lm(wage ~ age + I(age^<span class="hljs-number">2</span>) + I(age^<span class="hljs-number">3</span>) + I(age^<span class="hljs-number">4</span>), data = Wage)
coef(fit2a)
</code></pre>
<pre><code>##   (Intercept)           age      I(age^2)      I(age^3)      I(age^4) 
## -1.841542e+02  2.124552e+01 -5.638593e-01  6.810688e-03 -3.203830e-05
</code></pre><p>A more compact version of the same example uses <a href="http://bit.ly/R_cbind" target="_blank"><code>cbind()</code></a> and eliminates the need to wrap each term in <a href="http://bit.ly/R_asis" target="_blank"><code>I()</code></a>.</p>
<pre><code class="lang-r">fit2b &lt;- lm(wage ~ cbind(age, age^<span class="hljs-number">2</span>, age^<span class="hljs-number">3</span>, age^<span class="hljs-number">4</span>), data = Wage)
</code></pre>
<p>We can create an age grid for the targted values of the prediction and pass the grid to <a href="http://bit.ly/R_predict" target="_blank"><code>predict()</code></a>.</p>
<pre><code class="lang-r">agelims &lt;- range(age)
age.grid &lt;- seq(from = agelims[<span class="hljs-number">1</span>], to = agelims[<span class="hljs-number">2</span>])
preds &lt;- predict(fit, newdata = list(age = age.grid), se = <span class="hljs-literal">TRUE</span>)
se.bands &lt;- cbind(preds$fit + <span class="hljs-number">2</span> * preds$se.fit, preds$fit - <span class="hljs-number">2</span> * preds$se.fit)
</code></pre>
<pre><code class="lang-r">preds2 &lt;- predict(fit2, newdata = list(age = age.grid), se = <span class="hljs-literal">TRUE</span>)
max(abs(preds$fit - preds2$fit))
</code></pre>
<pre><code>## [1] 7.81597e-11
</code></pre><p>We can use <a href="http://bit.ly/R_anova" target="_blank"><code>anova()</code></a> to compare five different models of linear fit.</p>
<pre><code class="lang-r">fit.1 &lt;- lm(wage ~ age, data = Wage)
fit.2 &lt;- lm(wage ~ poly(age, <span class="hljs-number">2</span>), data = Wage)
fit.3 &lt;- lm(wage ~ poly(age, <span class="hljs-number">3</span>), data = Wage)
fit.4 &lt;- lm(wage ~ poly(age, <span class="hljs-number">4</span>), data = Wage)
fit.5 &lt;- lm(wage ~ poly(age, <span class="hljs-number">5</span>), data = Wage)
anova(fit.1, fit.2, fit.3, fit.4, fit.5)
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:right">Res.Df</th>
<th style="text-align:right">RSS</th>
<th style="text-align:right">Df</th>
<th style="text-align:right">Sum of Sq</th>
<th style="text-align:right">F</th>
<th style="text-align:right">Pr(&gt;F)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">2998</td>
<td style="text-align:right">5022216</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
</tr>
<tr>
<td style="text-align:right">2997</td>
<td style="text-align:right">4793430</td>
<td style="text-align:right">1</td>
<td style="text-align:right">228786.010</td>
<td style="text-align:right">143.5931074</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:right">2996</td>
<td style="text-align:right">4777674</td>
<td style="text-align:right">1</td>
<td style="text-align:right">15755.694</td>
<td style="text-align:right">9.8887559</td>
<td style="text-align:right">0.0016792</td>
</tr>
<tr>
<td style="text-align:right">2995</td>
<td style="text-align:right">4771604</td>
<td style="text-align:right">1</td>
<td style="text-align:right">6070.152</td>
<td style="text-align:right">3.8098134</td>
<td style="text-align:right">0.0510462</td>
</tr>
<tr>
<td style="text-align:right">2994</td>
<td style="text-align:right">4770322</td>
<td style="text-align:right">1</td>
<td style="text-align:right">1282.563</td>
<td style="text-align:right">0.8049758</td>
<td style="text-align:right">0.3696820</td>
</tr>
</tbody>
</table>
<p>The same p-values can also be obtained from the <a href="http://bit.ly/R_coef" target="_blank"><code>coef()</code></a> function.</p>
<pre><code class="lang-r">coef(summary(fit.5))
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:right">Estimate</th>
<th style="text-align:right">Std. Error</th>
<th style="text-align:right">t value</th>
<th style="text-align:right">Pr(&gt;|t|)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(Intercept)</td>
<td style="text-align:right">111.70361</td>
<td style="text-align:right">0.7287647</td>
<td style="text-align:right">153.2780243</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 5)1</td>
<td style="text-align:right">447.06785</td>
<td style="text-align:right">39.9160847</td>
<td style="text-align:right">11.2001930</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 5)2</td>
<td style="text-align:right">-478.31581</td>
<td style="text-align:right">39.9160847</td>
<td style="text-align:right">-11.9830341</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 5)3</td>
<td style="text-align:right">125.52169</td>
<td style="text-align:right">39.9160847</td>
<td style="text-align:right">3.1446392</td>
<td style="text-align:right">0.0016792</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 5)4</td>
<td style="text-align:right">-77.91118</td>
<td style="text-align:right">39.9160847</td>
<td style="text-align:right">-1.9518743</td>
<td style="text-align:right">0.0510462</td>
</tr>
<tr>
<td style="text-align:left">poly(age, 5)5</td>
<td style="text-align:right">-35.81289</td>
<td style="text-align:right">39.9160847</td>
<td style="text-align:right">-0.8972045</td>
<td style="text-align:right">0.3696820</td>
</tr>
</tbody>
</table>
<p>The <a href="http://bit.ly/R_anova" target="_blank"><code>anova()</code></a> function can also compare the variances when other terms are included as predictors.</p>
<pre><code class="lang-r">fit.1 &lt;- lm(wage ~ education + age, data = Wage)
fit.2 &lt;- lm(wage ~ education + poly(age, <span class="hljs-number">2</span>), data = Wage)
fit.3 &lt;- lm(wage ~ education + poly(age, <span class="hljs-number">3</span>), data = Wage)
anova(fit.1, fit.2, fit.3)
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:right">Res.Df</th>
<th style="text-align:right">RSS</th>
<th style="text-align:right">Df</th>
<th style="text-align:right">Sum of Sq</th>
<th style="text-align:right">F</th>
<th style="text-align:right">Pr(&gt;F)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">2994</td>
<td style="text-align:right">3867992</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
</tr>
<tr>
<td style="text-align:right">2993</td>
<td style="text-align:right">3725395</td>
<td style="text-align:right">1</td>
<td style="text-align:right">142597.10</td>
<td style="text-align:right">114.696898</td>
<td style="text-align:right">0.0000000</td>
</tr>
<tr>
<td style="text-align:right">2992</td>
<td style="text-align:right">3719809</td>
<td style="text-align:right">1</td>
<td style="text-align:right">5586.66</td>
<td style="text-align:right">4.493588</td>
<td style="text-align:right">0.0341043</td>
</tr>
</tbody>
</table>
<p>With <a href="http://bit.ly/R_glm" target="_blank"><code>glm()</code></a> we can also fit a polynomial logistic regression.</p>
<pre><code class="lang-r">fit &lt;- glm(I(wage &gt; <span class="hljs-number">250</span>) ~ poly(age, <span class="hljs-number">4</span>), data = Wage, family = binomial)
</code></pre>
<p>And use the same method for making predictions using <a href="http://bit.ly/R_predict" target="_blank"><code>predict()</code></a> as seen above.</p>
<pre><code class="lang-r">preds &lt;- predict(fit, newdata = list(age = age.grid), se = <span class="hljs-literal">T</span>)
</code></pre>
<pre><code class="lang-r">pfit &lt;- exp(preds$fit)/(<span class="hljs-number">1</span> + exp(preds$fit))
se.bands.logit &lt;- cbind(preds$fit + <span class="hljs-number">2</span> * preds$se.fit, preds$fit - <span class="hljs-number">2</span> * preds$se.fit)
se.bands &lt;- exp(se.bands.logit)/(<span class="hljs-number">1</span> + exp(se.bands.logit))
</code></pre>
<pre><code class="lang-r">preds &lt;- predict(fit, newdata = list(age = age.grid), type = <span class="hljs-string">&quot;response&quot;</span>, se = <span class="hljs-literal">T</span>)
</code></pre>
<p>We can plot these results with the <a href="http://bit.ly/R_plot" target="_blank"><code>plot()</code></a> function as usual.</p>
<pre><code class="lang-r">par(mfrow = c(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), mar = c(<span class="hljs-number">4.5</span>, <span class="hljs-number">4.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), oma = c(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>))
plot(age, wage, xlim = agelims, cex = <span class="hljs-number">0.5</span>, col = <span class="hljs-string">&quot;darkgrey&quot;</span>)
title(<span class="hljs-string">&quot;Degree -4 Polynomial &quot;</span>, outer = <span class="hljs-literal">T</span>)
lines(age.grid, preds$fit, lwd = <span class="hljs-number">2</span>, col = <span class="hljs-string">&quot;blue&quot;</span>)
matlines(age.grid, se.bands, lwd = <span class="hljs-number">1</span>, col = <span class="hljs-string">&quot;blue&quot;</span>, lty = <span class="hljs-number">3</span>)

plot(age, I(wage &gt; <span class="hljs-number">250</span>), xlim = agelims, type = <span class="hljs-string">&quot;n&quot;</span>, ylim = c(<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>))
points(jitter(age), I((wage &gt; <span class="hljs-number">250</span>)/<span class="hljs-number">5</span>), cex = <span class="hljs-number">0.5</span>, pch = <span class="hljs-string">&quot;|&quot;</span>, col = <span class="hljs-string">&quot; darkgrey &quot;</span>)
lines(age.grid, pfit, lwd = <span class="hljs-number">2</span>, col = <span class="hljs-string">&quot;blue&quot;</span>)
matlines(age.grid, se.bands, lwd = <span class="hljs-number">1</span>, col = <span class="hljs-string">&quot;blue&quot;</span>, lty = <span class="hljs-number">3</span>)
</code></pre>
<p><img src="figure/unnamed-chunk-15-1.png" alt="plot of chunk unnamed-chunk-15"> </p>
<p>In the above plot, the <a href="http://bit.ly/R_jitter" target="_blank"><code>jitter()</code></a> function is used to prevent the same age obervations from overlapping each other.</p>
<p>The <a href="http://bit.ly/R_cut" target="_blank"><code>cut()</code></a> functions creates cutpoints in the observations, which are then used as predictors for the linear model to fit a step function.</p>
<pre><code class="lang-r">table(cut(age, <span class="hljs-number">4</span>))
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:right">(17.9,33.5]</th>
<th style="text-align:right">(33.5,49]</th>
<th style="text-align:right">(49,64.5]</th>
<th style="text-align:right">(64.5,80.1]</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">750</td>
<td style="text-align:right">1399</td>
<td style="text-align:right">779</td>
<td style="text-align:right">72</td>
</tr>
</tbody>
</table>
<pre><code class="lang-r">fit &lt;- lm(wage ~ cut(age, <span class="hljs-number">4</span>), data = Wage)
coef(summary(fit))
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:right">Estimate</th>
<th style="text-align:right">Std. Error</th>
<th style="text-align:right">t value</th>
<th style="text-align:right">Pr(&gt;|t|)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(Intercept)</td>
<td style="text-align:right">94.158392</td>
<td style="text-align:right">1.476069</td>
<td style="text-align:right">63.789970</td>
<td style="text-align:right">0.000000</td>
</tr>
<tr>
<td style="text-align:left">cut(age, 4)(33.5,49]</td>
<td style="text-align:right">24.053491</td>
<td style="text-align:right">1.829431</td>
<td style="text-align:right">13.148074</td>
<td style="text-align:right">0.000000</td>
</tr>
<tr>
<td style="text-align:left">cut(age, 4)(49,64.5]</td>
<td style="text-align:right">23.664559</td>
<td style="text-align:right">2.067958</td>
<td style="text-align:right">11.443445</td>
<td style="text-align:right">0.000000</td>
</tr>
<tr>
<td style="text-align:left">cut(age, 4)(64.5,80.1]</td>
<td style="text-align:right">7.640592</td>
<td style="text-align:right">4.987424</td>
<td style="text-align:right">1.531972</td>
<td style="text-align:right">0.125635</td>
</tr>
</tbody>
</table>
<h3 id="7-8-2-splines">7.8.2 Splines</h3>
<p>We use the <code>splines</code> package to run regression splines. </p>
<pre><code class="lang-r"><span class="hljs-keyword">library</span>(splines)
</code></pre>
<p>We first use <a href="http://bit.ly/R_bs" target="_blank"><code>bs()</code></a> to generate a basis matrix for a polynomial spline and fit a model with knots at age 25, 40 and 60.</p>
<pre><code class="lang-r">fit &lt;- lm(wage ~ bs(age, knots = c(<span class="hljs-number">25</span>, <span class="hljs-number">40</span>, <span class="hljs-number">60</span>)), data = Wage)
pred &lt;- predict(fit, newdata = list(age = age.grid), se = <span class="hljs-literal">T</span>)
plot(age, wage, col = <span class="hljs-string">&quot;gray&quot;</span>)
lines(age.grid, pred$fit, lwd = <span class="hljs-number">2</span>)
lines(age.grid, pred$fit + <span class="hljs-number">2</span> * pred$se, lty = <span class="hljs-string">&quot;dashed&quot;</span>)
lines(age.grid, pred$fit - <span class="hljs-number">2</span> * pred$se, lty = <span class="hljs-string">&quot;dashed&quot;</span>)
</code></pre>
<p><img src="figure/unnamed-chunk-18-1.png" alt="plot of chunk unnamed-chunk-18"> </p>
<p>Alternatively, the <a href="http://bit.ly/R_dist" target="_blank"><code>df()</code></a> function can be used to produce a spline fit with knots at uniform intervals.</p>
<pre><code class="lang-r">dim(bs(age, knots = c(<span class="hljs-number">25</span>, <span class="hljs-number">40</span>, <span class="hljs-number">60</span>)))
</code></pre>
<pre><code>## [1] 3000    6
</code></pre><pre><code class="lang-r">dim(bs(age, df = <span class="hljs-number">6</span>))
</code></pre>
<pre><code>## [1] 3000    6
</code></pre><pre><code class="lang-r">attr(bs(age, df = <span class="hljs-number">6</span>), <span class="hljs-string">&quot;knots&quot;</span>)
</code></pre>
<pre><code>##   25%   50%   75% 
## 33.75 42.00 51.00
</code></pre><pre><code class="lang-r">plot(age, wage, col = <span class="hljs-string">&quot;gray&quot;</span>)
fit2 &lt;- lm(wage ~ ns(age, df = <span class="hljs-number">4</span>), data = Wage)
pred2 &lt;- predict(fit2, newdata = list(age = age.grid), se = <span class="hljs-literal">TRUE</span>)
lines(age.grid, pred2$fit, col = <span class="hljs-string">&quot;red&quot;</span>, lwd = <span class="hljs-number">2</span>)
</code></pre>
<p><img src="figure/unnamed-chunk-20-1.png" alt="plot of chunk unnamed-chunk-20"> </p>
<p>We can fit a smoothing spline using <a href="http://bit.ly/R_smooth_spline" target="_blank"><code>smooth.spline()</code></a></p>
<pre><code class="lang-r">plot(age, wage, xlim = agelims, cex = <span class="hljs-number">0.5</span>, col = <span class="hljs-string">&quot;darkgrey&quot;</span>)
title(<span class="hljs-string">&quot; Smoothing Spline &quot;</span>)
fit &lt;- smooth.spline(age, wage, df = <span class="hljs-number">16</span>)
fit2 &lt;- smooth.spline(age, wage, cv = <span class="hljs-literal">TRUE</span>)
</code></pre>
<pre><code>## Warning in smooth.spline(age, wage, cv = TRUE): cross-validation with non-
## unique &apos;x&apos; values seems doubtful
</code></pre><pre><code class="lang-r">fit2$df
</code></pre>
<pre><code>## [1] 6.794596
</code></pre><pre><code class="lang-r">lines(fit, col = <span class="hljs-string">&quot;red&quot;</span>, lwd = <span class="hljs-number">2</span>)
lines(fit2, col = <span class="hljs-string">&quot;blue&quot;</span>, lwd = <span class="hljs-number">2</span>)
legend(<span class="hljs-string">&quot;topright&quot;</span>, legend = c(<span class="hljs-string">&quot;16 DF&quot;</span>, <span class="hljs-string">&quot;6.8 DF&quot;</span>), col = c(<span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-string">&quot;blue&quot;</span>), lty = <span class="hljs-number">1</span>, lwd = <span class="hljs-number">2</span>, cex = <span class="hljs-number">0.8</span>)
</code></pre>
<p><img src="figure/unnamed-chunk-21-1.png" alt="plot of chunk unnamed-chunk-21"> </p>
<p>We can use <a href="http://bit.ly/R_loess" target="_blank"><code>loess()</code></a> function for a local polynomial regression.</p>
<pre><code class="lang-r">plot(age, wage, xlim = agelims, cex = <span class="hljs-number">0.5</span>, col = <span class="hljs-string">&quot;darkgrey&quot;</span>)
title(<span class="hljs-string">&quot; Local Regression &quot;</span>)
fit &lt;- loess(wage ~ age, span = <span class="hljs-number">0.2</span>, data = Wage)
fit2 &lt;- loess(wage ~ age, span = <span class="hljs-number">0.5</span>, data = Wage)
lines(age.grid, predict(fit, data.frame(age = age.grid)), col = <span class="hljs-string">&quot;red&quot;</span>, lwd = <span class="hljs-number">2</span>)
lines(age.grid, predict(fit2, data.frame(age = age.grid)), col = <span class="hljs-string">&quot;blue&quot;</span>, lwd = <span class="hljs-number">2</span>)
legend(<span class="hljs-string">&quot;topright&quot;</span>, legend = c(<span class="hljs-string">&quot;Span=0.2&quot;</span>, <span class="hljs-string">&quot;Span=0.5&quot;</span>), col = c(<span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-string">&quot;blue&quot;</span>), lty = <span class="hljs-number">1</span>, lwd = <span class="hljs-number">2</span>, cex = <span class="hljs-number">0.8</span>)
</code></pre>
<p><img src="figure/unnamed-chunk-22-1.png" alt="plot of chunk unnamed-chunk-22"> </p>
<h3 id="7-8-3-gams">7.8.3 GAMs</h3>
<p>We can fit a GAM with <a href="http://bit.ly/R_lm" target="_blank"><code>lm()</code></a> when an appropriate basis function can used.</p>
<pre><code class="lang-r">gam1 &lt;- lm(wage ~ ns(year, <span class="hljs-number">4</span>) + ns(age, <span class="hljs-number">5</span>) + education, data = Wage)
</code></pre>
<p>However, the <code>gam</code> package offers a general solution to fitting GAMs and is especially useful when splines cannot be easily expressed in terms of basis functions.</p>
<pre><code class="lang-r"><span class="hljs-keyword">library</span>(gam)
gam.m3 &lt;- gam(wage ~ s(year, <span class="hljs-number">4</span>) + s(age, <span class="hljs-number">5</span>) + education, data = Wage)
</code></pre>
<p>The <a href="http://bit.ly/R_plot" target="_blank"><code>plot()</code></a> functions the same way as it does with <a href="http://bit.ly/R_lm" target="_blank"><code>lm()</code></a> and <a href="http://bit.ly/R_glm" target="_blank"><code>glm()</code></a>.</p>
<pre><code class="lang-r">par(mfrow = c(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))
plot(gam.m3, se = <span class="hljs-literal">TRUE</span>, col = <span class="hljs-string">&quot;blue&quot;</span>)
</code></pre>
<pre><code>## Error in 1:object$nsdf: argument of length 0
</code></pre><pre><code class="lang-r">plot.gam(gam1, se = <span class="hljs-literal">TRUE</span>, col = <span class="hljs-string">&quot;red&quot;</span>)
</code></pre>
<p><img src="figure/unnamed-chunk-26-1.png" alt="plot of chunk unnamed-chunk-26"> <img src="figure/unnamed-chunk-26-2.png" alt="plot of chunk unnamed-chunk-26"> <img src="figure/unnamed-chunk-26-3.png" alt="plot of chunk unnamed-chunk-26"> </p>
<p>We can use <a href="http://bit.ly/R_anova" target="_blank"><code>annova()</code></a> to find the best performing model.</p>
<pre><code class="lang-r">gam.m1 &lt;- gam(wage ~ s(age, <span class="hljs-number">5</span>) + education, data = Wage)
gam.m2 &lt;- gam(wage ~ year + s(age, <span class="hljs-number">5</span>) + education, data = Wage)
anova(gam.m1, gam.m2, gam.m3, test = <span class="hljs-string">&quot;F&quot;</span>)
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:right">Resid. Df</th>
<th style="text-align:right">Resid. Dev</th>
<th style="text-align:right">Df</th>
<th style="text-align:right">Deviance</th>
<th style="text-align:right">F</th>
<th style="text-align:right">Pr(&gt;F)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">2990</td>
<td style="text-align:right">3711731</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
<td style="text-align:right">NA</td>
</tr>
<tr>
<td style="text-align:right">2989</td>
<td style="text-align:right">3693842</td>
<td style="text-align:right">1.000000</td>
<td style="text-align:right">17889.243</td>
<td style="text-align:right">14.477130</td>
<td style="text-align:right">0.0001447</td>
</tr>
<tr>
<td style="text-align:right">2986</td>
<td style="text-align:right">3689770</td>
<td style="text-align:right">2.999989</td>
<td style="text-align:right">4071.134</td>
<td style="text-align:right">1.098212</td>
<td style="text-align:right">0.3485661</td>
</tr>
</tbody>
</table>
<p>And use <a href="http://bit.ly/R_summary" target="_blank"><code>summary()</code></a> to generate a summary of the fitted model.</p>
<pre><code class="lang-r">summary(gam.m3)
</code></pre>
<pre><code>## 
## Call: gam(formula = wage ~ s(year, 4) + s(age, 5) + education, data = Wage)
## Deviance Residuals:
##     Min      1Q  Median      3Q     Max 
## -119.43  -19.70   -3.33   14.17  213.48 
## 
## (Dispersion Parameter for gaussian family taken to be 1235.69)
## 
##     Null Deviance: 5222086 on 2999 degrees of freedom
## Residual Deviance: 3689770 on 2986 degrees of freedom
## AIC: 29887.75 
## 
## Number of Local Scoring Iterations: 2 
## 
## Anova for Parametric Effects
##              Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
## s(year, 4)    1   27162   27162  21.981 2.877e-06 ***
## s(age, 5)     1  195338  195338 158.081 &lt; 2.2e-16 ***
## education     4 1069726  267432 216.423 &lt; 2.2e-16 ***
## Residuals  2986 3689770    1236                      
## ---
## Signif. codes:  0 &apos;***&apos; 0.001 &apos;**&apos; 0.01 &apos;*&apos; 0.05 &apos;.&apos; 0.1 &apos; &apos; 1
## 
## Anova for Nonparametric Effects
##             Npar Df Npar F  Pr(F)    
## (Intercept)                          
## s(year, 4)        3  1.086 0.3537    
## s(age, 5)         4 32.380 &lt;2e-16 ***
## education                            
## ---
## Signif. codes:  0 &apos;***&apos; 0.001 &apos;**&apos; 0.01 &apos;*&apos; 0.05 &apos;.&apos; 0.1 &apos; &apos; 1
</code></pre><p>We can make predictions using <a href="http://bit.ly/R_predict" target="_blank"><code>predict()</code></a> just as we did with linear and logistic regressions.</p>
<pre><code class="lang-r">preds &lt;- predict(gam.m2, newdata = Wage)
</code></pre>
<p>We can use a loess fit as a smoothing term in a GAM formula using the <a href="http://bit.ly/R_gam_lo" target="_blank"><code>lo()</code></a> </p>
<pre><code class="lang-r">gam.lo &lt;- gam(wage ~ s(year, df = <span class="hljs-number">4</span>) + lo(age, span = <span class="hljs-number">0.7</span>) + education, data = Wage)
plot.gam(gam.lo, se = <span class="hljs-literal">TRUE</span>, col = <span class="hljs-string">&quot;green&quot;</span>)
</code></pre>
<pre><code>## Error in 1:object$nsdf: argument of length 0
</code></pre><pre><code class="lang-r">gam.lo.i &lt;- gam(wage ~ lo(year, age, span = <span class="hljs-number">0.5</span>) + education, data = Wage)
</code></pre>
<p>The <code>akima</code> package can be used to plot tw-dimentional surface plots. Make sure the package is part of your R installation or install it with <a href="http://bit.ly/R_install_packages" target="_blank"><code>install.packages()</code></a> if necessary.</p>
<pre><code class="lang-r"><span class="hljs-keyword">library</span>(akima)
plot(gam.lo.i)
</code></pre>
<pre><code>## Error in 1:object$nsdf: argument of length 0
</code></pre><p>The <a href="http://bit.ly/R_gam" target="_blank"><code>gam()</code></a> function also allows fitting logistic regression GAM with the <code>family = binomial</code> argument.</p>
<pre><code class="lang-r">gam.lr &lt;- gam(I(wage &gt; <span class="hljs-number">250</span>) ~ year + s(age, df = <span class="hljs-number">5</span>) + education, family = binomial, data = Wage)
par(mfrow = c(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))
plot(gam.lr, se = <span class="hljs-literal">T</span>, col = <span class="hljs-string">&quot;green&quot;</span>)
</code></pre>
<pre><code>## Error in 1:object$nsdf: argument of length 0
</code></pre><pre><code class="lang-r">table(education, I(wage &gt; <span class="hljs-number">250</span>))
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">education/</th>
<th style="text-align:right">FALSE</th>
<th style="text-align:right">TRUE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1. &lt; HS Grad</td>
<td style="text-align:right">268</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">2. HS Grad</td>
<td style="text-align:right">966</td>
<td style="text-align:right">5</td>
</tr>
<tr>
<td style="text-align:left">3. Some College</td>
<td style="text-align:right">643</td>
<td style="text-align:right">7</td>
</tr>
<tr>
<td style="text-align:left">4. College Grad</td>
<td style="text-align:right">663</td>
<td style="text-align:right">22</td>
</tr>
<tr>
<td style="text-align:left">5. Advanced Degree</td>
<td style="text-align:right">381</td>
<td style="text-align:right">45</td>
</tr>
</tbody>
</table>
<pre><code class="lang-r">gam.lr.s &lt;- gam(I(wage &gt; <span class="hljs-number">250</span>) ~ year + s(age, df = <span class="hljs-number">5</span>) + education, family = binomial, data = Wage, subset = (education != <span class="hljs-string">&quot;1. &lt; HS Grad&quot;</span>))
plot(gam.lr.s, se = <span class="hljs-literal">T</span>, col = <span class="hljs-string">&quot;green&quot;</span>)
</code></pre>
<pre><code>## Error in 1:object$nsdf: argument of length 0
</code></pre>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../week5/index.html" class="navigation navigation-prev " aria-label="Previous page: Chapter 7. Moving Beyond Linearity"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../ISLR/chapter7/solutions.html" class="navigation navigation-next " aria-label="Next page: Solutions"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
